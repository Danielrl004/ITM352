<head>
  <script src="./functions.js"></script>
  <link href="cart-style.css" rel="stylesheet">
  <script>
        var cookie;
        var user_data;
        var products;
        var subtotal = 0;
        loadJSON('get_products_data', function (response) {
            // Parsing JSON string into object
            products = JSON.parse(response);
        });
        loadJSON('get_cart', function (response) {
            // Parsing JSON string into object
            shopping_cart = JSON.parse(response);
        });

        loadJSON('get_cookies', function(response) {
         // Parsing JSON string into object
         cookie = JSON.parse(response);
    });
    loadJSON('get_users', function(response) {
         // Parsing JSON string into object
         user_data = JSON.parse(response);
    });

  </script>
</head>
<header>
  <img src='./images/logo.jpg'>
  <nav>
    <ul>
      <li><a href='index.html'>HOME<a></li>
      <li>
        <script>nav_bar('', products);</script>
      </li>
      <script>
        //Defines user_email to be what email was entered and saved into the cookies
        user_email = cookie.email;
        //Defines ifLoggedIn to be 
        ifLoggedIn = cookie.loggedIn;
        if (ifLoggedIn == 'true') {
          document.write('<li><a href="get_to_logout">Logout</a></li>')
        } else {
          document.write('<li><a href="get_to_login">Login</a></li>');
        }
      </script>
    </ul>
  </nav>
</header>
<form action="update_cart" method="post">
<body>

<center><h2>You have in your shopping cart:</h2></center>
<center><table border><th>Quantity</th><th>Item</th><th>Price</th><th>Extended Price</th></center>


<script>
checkboxes = document.querySelectorAll('input[type="checkbox"]');


  for(product_key in products) {
    for(i=0; i<products[product_key].length; i++) {
        if(typeof shopping_cart[product_key] == 'undefined') continue;
        qty = shopping_cart[product_key][i];
        extended_price = qty * products[product_key][i].price;
        (subtotal += extended_price)
        if(qty > 0) {
          var product = products[product_key][i];
          document.write(`
          <tr>
          <td>
            <input type="checkbox" id="favorite-<%= ${i} %>">
            <label for="favorite-<%= ${i} %>"><%= ${product[i]} %></label> 
          </td>
          <td><center>
                <button type="button" id="increaseButton" onclick="window.location.href = '/increase_quantity?prodID=${product.id}&product_key=${product_key}'">+</button>
              <input type="text" id="textbox" value="${qty}" style="width: 20px">
              <button type="button" id="decreaseButton" onclick="window.location.href = '/decrease_quantity?prodID=${product.id}&product_key=${product_key}'">-</button>
            </center></td>
            <td>${products[product_key][i].name} <img src="./images/${products[product_key][i].image}" WIDTH = 60px</td>
                <td>\$${products[product_key][i].price}</td>
                <td>\$${extended_price}</td></tr></center>
                <tr>
                  `);

        }
    }
}  
  if (subtotal == 0) {
    alert(`No items in cart`);
    location.href = "index.html";
    var tax = 0;
    var shipping = 0;
    var grand_total = 0;
  }
  else {
    // Compute tax
    var tax_rate = 0.045;
    var tax = tax_rate * subtotal;

    // Compute shipping
    if (subtotal <= 20) {
      shipping = 5;
    }
    else if (subtotal <= 50) {
      shipping = 8;
    }
    else {
      shipping = 0.1 * subtotal; // 10% of subtotal
    }
    // Compute grand total
    var grand_total = subtotal + tax + shipping;
  }
</script>

        <tr>
          <td colspan="4" width="100%">&nbsp;</td>
        </tr>
        <tr>
          <td style="text-align: center;" colspan="3" width="67%">Sub-total</td>
          <td width="54%">$<script>document.write(subtotal.toFixed(2));</script></td>
        </tr>
        <tr>
          <td style="text-align: center;" colspan="3" width="67%"><span style="font-family: arial;">Tax @ <script>document.write(100*tax_rate);</script>%</span></td>
          <td width="54%">$<script>document.write(tax.toFixed(2));</script></td>
        </tr>
        <tr>
          <td style="text-align: center;" colspan="3" width="67%">Shipping<span style="font-family: arial;">
          <td width="54%">$<script>document.write(shipping.toFixed(2));</script></td>
        </tr>
        <tr>
          <td style="text-align: center;" colspan="3" width="67%"><strong>Total</strong></td>
          <td width="54%"><strong>$<script>document.write(grand_total.toFixed(2));</script></strong></td>
        </tr>
      </tbody>
    </table> 
    <div style = "font-weight: bold;">
      OUR SHIPPING POLICY IS:A subtotal $0 - $49.99 will be $5 shipping
      <br>
    A subtotal $50 - $99.99 will be $10 shipping
    <br>
  Subtotals over $100 will be charged 5% of the subtotal amount
    </div>
</body>
</footer>
</table>
  <input type="submit" class="update" value="Update Cart"></input>
  </form>  
  <script>
if(ifLoggedIn == "true") {
  document.write(`
  <br>
  <form action="checkout" method=post>
    <input type="submit" class="checkout" value="Checkout"></input>
  </form>
  `)
}
</script>